openapi: 3.0.3
info:
  title: Ribbony API
  version: 0.1.0
  description: |
    Canonical OpenAPI spec for Ribbony (accepted draft).
    Covers Auth, Product, Customizer, and Order APIs per SRS_Ribbony_v1.0.
servers:
  - url: https://api.ribbony.local
    description: Local dev
  - url: https://api.ribbony.com
    description: Production (placeholder)
tags:
  - name: auth
    description: Authentication and user endpoints
  - name: products
    description: Product browsing and management
  - name: customizer
    description: Magazine payload validation & preview
  - name: orders
    description: Order lifecycle and admin operations
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ---- Auth ----
    UserRegister:
      type: object
      required: [name, email, password]
      properties:
        name:
          type: string
          example: "Ali Mahmoud"
        email:
          type: string
          format: email
          example: "ali@example.com"
        password:
          type: string
          format: password
          minLength: 8

    UserLogin:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    AuthResponse:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        tokenType:
          type: string
          example: "Bearer"
        expiresIn:
          type: integer
          description: seconds until expiry

    UserDto:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
        roles:
          type: array
          items:
            type: string
            enum: [ADMIN, CUSTOMER]

    # ---- Product ----
    ProductCreate:
      type: object
      required: [name, price]
      properties:
        name:
          type: string
        description:
          type: string
        images:
          type: array
          items:
            type: string
            format: uri
        price:
          type: number
          format: double

    ProductDto:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        images:
          type: array
          items:
            type: string
            format: uri
        price:
          type: number
          format: double
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ---- Customizer / Magazine Payload (JSONB) ----
    MagazinePage:
      type: object
      properties:
        pageNumber:
          type: integer
        fields:
          type: array
          items:
            type: object
            additionalProperties: true
        photos:
          type: array
          items:
            type: string
            format: uri

    MagazinePayload:
      type: object
      required: [pageCount, pages]
      properties:
        pageCount:
          type: integer
          enum: [8, 12]
        colorPalette:
          type: string
        pages:
          type: array
          items:
            $ref: '#/components/schemas/MagazinePage'

    # Validation error structure (field-level)
    FieldError:
      type: object
      properties:
        field:
          type: string
        message:
          type: string

    ValidationError:
      type: object
      properties:
        code:
          type: string
          example: "VALIDATION_ERROR"
        message:
          type: string
        fieldErrors:
          type: array
          items:
            $ref: '#/components/schemas/FieldError'

    # ---- Preview ----
    PreviewMetadata:
      type: object
      properties:
        previewUrl:
          type: string
          format: uri
          description: "Optional URL to a generated preview (short-lived)."
        pages:
          type: integer
        estimatedSizeBytes:
          type: integer
        warnings:
          type: array
          items:
            type: string

    # ---- Order ----
    PriceBreakdown:
      type: object
      properties:
        productPrice:
          type: number
          format: double
        customizerFee:
          type: number
          format: double
        shippingFee:
          type: number
          format: double
        total:
          type: number
          format: double

    OrderCreate:
      type: object
      required: [productId, payload]
      properties:
        productId:
          type: string
          format: uuid
        payload:
          $ref: '#/components/schemas/MagazinePayload'
        note:
          type: string

    OrderStatus:
      type: string
      enum:
        - PENDING
        - WORK_IN_PROGRESS
        - SHIPPED

    OrderDto:
      type: object
      properties:
        id:
          type: string
          format: uuid
        customerId:
          type: string
          format: uuid
        product:
          $ref: '#/components/schemas/ProductDto'
        payload:
          $ref: '#/components/schemas/MagazinePayload'
        priceBreakdown:
          $ref: '#/components/schemas/PriceBreakdown'
        status:
          $ref: '#/components/schemas/OrderStatus'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string

paths:
  # ---------------- AUTH ----------------
  /auth/register:
    post:
      tags: [auth]
      summary: Register a new customer
      description: "Create a new CUSTOMER user. Passwords must be hashed with BCrypt."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegister'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDto'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-srs:
        - FR-1

  /auth/login:
    post:
      tags: [auth]
      summary: Login and get access + refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLogin'
      responses:
        '200':
          description: Auth tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-srs:
        - FR-2

  /auth/refresh:
    post:
      tags: [auth]
      summary: Exchange refresh token for new access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: New access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid/expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-srs:
        - FR-2

  /auth/me:
    get:
      tags: [auth]
      summary: Return current authenticated user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDto'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-srs:
        - FR-4

  # ---------------- PRODUCTS ----------------
  /products:
    get:
      tags: [products]
      summary: List products
      description: Returns paginated list of products
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 0
        - in: query
          name: size
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of products
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProductDto'
                  page:
                    type: integer
                  size:
                    type: integer
                  totalElements:
                    type: integer
        '500':
          $ref: '#/components/schemas/Error'
      x-srs:
        - FR-5

    post:
      tags: [products]
      summary: Create a product (ADMIN)
      security:
        - bearerAuth: []
      description: ADMIN only — create product entity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductDto'
        '403':
          description: Forbidden
      x-srs:
        - FR-7

  /products/{id}:
    get:
      tags: [products]
      summary: Get product details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Product detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductDto'
        '404':
          description: Not found
      x-srs:
        - FR-6

    put:
      tags: [products]
      summary: Update product (ADMIN)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreate'
      responses:
        '200':
          description: Updated product
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductDto'
        '403':
          description: Forbidden
      x-srs:
        - FR-7

    delete:
      tags: [products]
      summary: Delete product (ADMIN)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted
        '403':
          description: Forbidden
      x-srs:
        - FR-7

  # ---------------- CUSTOMIZER ----------------
  /customizer/validate:
    post:
      tags: [customizer]
      summary: Validate Magazine payload (server-side)
      description: |
        Validates the magazine payload according to SRS:
        - pageCount must be 8 or 12
        - required per-page fields must be present
        - total photos size <= 50 MB (server validates via Cloudinary metadata or client-provided metadata)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MagazinePayload'
      responses:
        '200':
          description: Payload valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
        '400':
          description: Validation errors (field-level)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
      x-srs:
        - FR-8
        - FR-9
        - FR-10

  /customizer/preview:
    post:
      tags: [customizer]
      summary: Generate a preview for a Magazine payload
      description: |
        Optionally generates a short-lived preview (render) or returns preview metadata.
        Implementation note: preview generation may be async; contract returns metadata or previewUrl when ready.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MagazinePayload'
      responses:
        '200':
          description: Preview metadata (preview may be generated synchronously or a URL to check status)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PreviewMetadata'
        '400':
          description: Validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
      x-srs:
        - FR-8

  # ---------------- ORDERS ----------------
  /orders:
    post:
      tags: [orders]
      summary: Create an order (Customer)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCreate'
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDto'
        '400':
          description: Validation error (payload size, required fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
      x-srs:
        - FR-11
        - FR-8
        - FR-9
        - FR-10

    get:
      tags: [orders]
      summary: Get orders for current customer
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/OrderStatus'
            nullable: true
      responses:
        '200':
          description: Customer's orders
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderDto'
      x-srs:
        - FR-12

  /admin/orders:
    get:
      tags: [orders]
      summary: Admin — view all orders (filter by status)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/OrderStatus'
      responses:
        '200':
          description: Orders listing
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderDto'
        '403':
          description: Forbidden
      x-srs:
        - FR-13

  /admin/orders/{id}/status:
    put:
      tags: [orders]
      summary: Admin — update order status
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  $ref: '#/components/schemas/OrderStatus'
      responses:
        '200':
          description: Updated order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDto'
        '400':
          description: Illegal status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
      x-srs:
        - FR-14

  /admin/orders/{id}/download:
    get:
      tags: [orders]
      summary: Admin — download ZIP of order media (optional)
      description: Returns application/zip. Optional per SRS (FR-15). Use streaming on server.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: ZIP file
          content:
            application/zip:
              schema:
                type: string
                format: binary
        '404':
          description: Not found
        '403':
          description: Forbidden
      x-srs:
        - FR-15

security:
  - bearerAuth: []
